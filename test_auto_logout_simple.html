<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Logout Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .info {
            color: #17a2b8;
        }

        .warning {
            color: #ffc107;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.authenticated {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.not-authenticated {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>🔍 Auto-Logout Test</h1>

        <div class="test-section">
            <h2>📊 Current Status</h2>
            <div id="status" class="status"></div>
            <button onclick="checkAuthStatus()">🔄 Refresh Status</button>
        </div>

        <div class="test-section">
            <h2>🧪 Test Controls</h2>
            <button onclick="startTest()">🚀 Start Auto-Logout Test</button>
            <button onclick="simulateTabSwitch()">🔄 Simulate Tab Switch</button>
            <button onclick="clearLog()">🗑️ Clear Log</button>
        </div>

        <div class="test-section">
            <h2>📝 Test Log</h2>
            <div id="log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>📋 Instructions</h2>
            <ol>
                <li>First, make sure you're logged into your application in another tab</li>
                <li>Click "Start Auto-Logout Test" to begin monitoring</li>
                <li>Switch between tabs multiple times</li>
                <li>Check if you get logged out</li>
                <li>Use "Simulate Tab Switch" to test programmatically</li>
            </ol>
        </div>
    </div>

    <script>
        let testRunning = false;
        let testResults = [];

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            testResults = [];
        }

        function updateStatus() {
            const statusElement = document.getElementById('status');
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');

            if (token) {
                statusElement.className = 'status authenticated';
                statusElement.innerHTML = `
                    <strong>✅ Authenticated</strong><br>
                    Token: ${token.substring(0, 20)}...<br>
                    User: ${user || 'Unknown'}<br>
                    Time: ${new Date().toLocaleTimeString()}
                `;
            } else {
                statusElement.className = 'status not-authenticated';
                statusElement.innerHTML = `
                    <strong>❌ Not Authenticated</strong><br>
                    No access token found<br>
                    Time: ${new Date().toLocaleTimeString()}
                `;
            }
        }

        function checkAuthStatus() {
            updateStatus();
            const token = localStorage.getItem('access_token');
            log(`Auth check: ${token ? 'Token found' : 'No token'}`, token ? 'success' : 'error');
            return !!token;
        }

        function simulateTabSwitch() {
            log('🔄 Simulating tab switch...', 'info');

            // Simulate tab becoming hidden
            Object.defineProperty(document, 'hidden', {
                value: true,
                writable: true
            });
            document.dispatchEvent(new Event('visibilitychange'));

            setTimeout(() => {
                // Simulate tab becoming visible
                Object.defineProperty(document, 'hidden', {
                    value: false,
                    writable: true
                });
                document.dispatchEvent(new Event('visibilitychange'));

                setTimeout(() => {
                    const wasAuthenticated = checkAuthStatus();
                    if (wasAuthenticated) {
                        log('✅ Still authenticated after tab switch', 'success');
                        testResults.push({ test: 'tab_switch', result: 'success', timestamp: Date.now() });
                    } else {
                        log('❌ AUTO-LOGOUT DETECTED!', 'error');
                        testResults.push({ test: 'tab_switch', result: 'failed', timestamp: Date.now() });
                    }
                }, 1000);
            }, 1000);
        }

        function startTest() {
            if (testRunning) {
                log('⚠️ Test already running', 'warning');
                return;
            }

            testRunning = true;
            log('🚀 Starting auto-logout test...', 'info');

            // Check initial state
            const initialAuth = checkAuthStatus();
            if (!initialAuth) {
                log('❌ Not authenticated - please login first', 'error');
                testRunning = false;
                return;
            }

            log('✅ Initial authentication confirmed', 'success');

            // Set up monitoring
            const originalHidden = Object.getOwnPropertyDescriptor(document, 'hidden');
            let switchCount = 0;

            // Monitor visibility changes
            document.addEventListener('visibilitychange', () => {
                if (!testRunning) return;

                if (!document.hidden) {
                    switchCount++;
                    log(`🔄 Tab became visible (switch #${switchCount})`, 'info');

                    setTimeout(() => {
                        const stillAuth = checkAuthStatus();
                        if (stillAuth) {
                            log(`✅ Still authenticated after switch #${switchCount}`, 'success');
                            testResults.push({ test: `switch_${switchCount}`, result: 'success', timestamp: Date.now() });
                        } else {
                            log(`❌ AUTO-LOGOUT DETECTED on switch #${switchCount}!`, 'error');
                            testResults.push({ test: `switch_${switchCount}`, result: 'failed', timestamp: Date.now() });
                        }
                    }, 1000);
                }
            });

            log('📊 Monitoring tab switches... Switch tabs to test', 'info');
            log('💡 Tip: Use Ctrl+Tab or click between browser tabs', 'info');
        }

        function stopTest() {
            testRunning = false;
            log('🛑 Test stopped', 'info');

            // Show results
            const successCount = testResults.filter(r => r.result === 'success').length;
            const totalCount = testResults.length;

            if (totalCount > 0) {
                log(`📊 Test Results: ${successCount}/${totalCount} successful`, successCount === totalCount ? 'success' : 'error');

                if (successCount === totalCount) {
                    log('🎉 SUCCESS: No auto-logout detected!', 'success');
                } else {
                    log('💥 FAILED: Auto-logout detected!', 'error');
                }
            }
        }

        // Initialize
        updateStatus();
        log('🔍 Auto-logout test page loaded', 'info');
        log('💡 Make sure you are logged into your application in another tab', 'info');
    </script>
</body>

</html>